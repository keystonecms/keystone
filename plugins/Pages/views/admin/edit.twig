{% extends '@pages/admin/layout.twig' %}

{% block title %}Edit page – Keystone{% endblock %}

{% block styles %}
<link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
<style>
    .ql-editor {
        min-height: 320px;
    }
</style>
{% endblock %}

{% block content %}

{% include '@pages/admin/_page_subnav.twig' with {
  page: page,
  active: 'content'
} %}


<div class="text-muted small mb-2">
    <span id="autosave-status">
        Not saved yet
    </span>
</div>

<form id="form-page-edit"
      method="post"
      action="/admin/pages/{{ page.id }}/save"
      data-reload="false">

    {{ csrf() }}



    <div class="alert alert-success d-none"></div>
    <div class="alert alert-danger d-none"></div>

  <div class="card-body">

     <div class="mb-3">
      <label class="form-label">Titel</label>
      <input
        type="text"
        name="title"
        class="form-control"
        value="{{ page.title }}"
        required
      >
    </div>

    <div class="mb-3">
      <label class="form-label">Slug</label>
      <input
        type="text"
        name="slug"
        class="form-control"
        value="{{ page.slug }}"
      >
    </div>

        <div class="mb-3">
    <label class="form-label">Template</label>
    <select name="template" class="form-select">
        <option value="default">Default</option>
        <option value="landing">Landing</option>
        <option value="homepage">Homepage</option>
        <option value="full-width">Full width</option>
    </select>
</div>


    <div class="mb-3">
      <label class="form-label">Content</label>
      <textarea
        id="editor"
        name="content"
        class="form-control"
        rows="14"
      >{{ page.content }}</textarea>
    </div>

  </div>

  <div class="card-footer text-end">
    <button class="btn btn-primary">
      Opslaan
    </button>
  </div>
</form>

{% endblock %}


{% block scripts %}
<script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
<script src="{{url}}/assets/js/multiform-ajax.js"></script>
<script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>

<script>
(function () {

    const quill = new Quill('#editor', {
        theme: 'snow',
        modules: {
            toolbar: [
                ['bold', 'italic', 'underline'],
                [{ header: [2, 3, false] }],
                [{ list: 'ordered' }, { list: 'bullet' }],
                ['blockquote'],
                ['image'],
                ['clean']
            ]
        }
    });

    /* Media picker integration */
    const toolbar = quill.getModule('toolbar');
    toolbar.addHandler('image', function () {
        window.open(
            '/admin/media?picker=1',
            'mediaPicker',
            'width=900,height=600'
        );
    });

    /* sync quill → textarea before AJAX submit */
    $('form[id*=form]').on('submit', function () {
        $('textarea[name=content]').val(
            quill.root.innerHTML
        );
    });

    /* exposed for media picker */
    window.insertImage = function (url) {
        const range = quill.getSelection(true);
        quill.insertEmbed(range.index, 'image', url);
        quill.formatText(range.index, 1, 'alt', '');
        quill.setSelection(range.index + 1);
    };

    let lastContent = '';
    let autosaveTimer = null;

function getPayload() {
    return {
        title: $('input[name="title"]').val(),
        slug: $('input[name="slug"]').val(),
        template: $('select[name="template"]').find(":selected").val(),
        content: quill.root.innerHTML,
        _csrf_token: $('input[name="_csrf_token"]').val()
    };
}


    function hasChanges() {
        const current = quill.root.innerHTML;
        return current !== lastContent;
    }

function autosave() {
    if (!hasChanges()) return;

    $.ajax({
        url: '/admin/pages/{{ page.id }}/autosave',
        type: 'POST',
        dataType: 'json',
        data: getPayload(),

        success: function (response) {
            if (response.status === 'success') {
                lastContent = quill.root.innerHTML;
                $('#autosave-status').text(
                    'Last saved at ' + response.savedAt
                );
            }
        }
    });
}


    // initial snapshot
    lastContent = quill.root.innerHTML;

    // autosave every 15s
    autosaveTimer = setInterval(autosave, 15000);

})();
</script>

{% endblock %}