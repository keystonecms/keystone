name: Signing

on:
  workflow_run:
    workflows: ["Version"]
    types:
      - completed

permissions:
  contents: write

jobs:
  release:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get latest tag
        run: |
          TAG=$(git describe --tags --abbrev=0)
          VERSION=${TAG#v}

          echo "TAG=$TAG" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_ENV

          echo "Signing tag: $TAG"
          echo "Version: $VERSION"

      - name: Build release zip
        run: |
          VERSION=${TAG#v}
          zip -r keystone-${VERSION}.zip . \
            -x "*.git*" "node_modules/*" "vendor/*"

      - name: Sign release
        env:
          KEYSTONE_SIGNING_KEY_B64: ${{ secrets.KEYSTONE_SIGNING_KEY_B64 }}
        run: |
          VERSION=${TAG#v}

          echo "$KEYSTONE_SIGNING_KEY_B64" | base64 -d > private.pem

          openssl dgst -sha256 \
            -sign private.pem \
            -out keystone-${VERSION}.zip.sig \
            keystone-${VERSION}.zip

          openssl dgst -sha256 \
            -sign private.pem \
            -out keystone-${VERSION}.zip.sig \
            keystone-${VERSION}.zip


          cat > latest.json <<EOF
            {
              "version": "$VERSION",
              "zip": "keystone-$VERSION.zip",
              "signature": "keystone-$VERSION.zip.sig"
            }
            EOF

          ls -l keystone-$VERSION.zip.sig
           
          shred -u private.pem || rm -f private.pem
      - name: Upload release assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG }}
          files: |
            keystone-${{ env.VERSION }}.zip
            keystone-${{ env.VERSION }}.zip.sig
            latest.json

